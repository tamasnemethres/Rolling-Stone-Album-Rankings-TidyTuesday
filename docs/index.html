<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tamas Nemeth">
<meta name="dcterms.date" content="2023-10-01">

<title>Rolling Stones Album Rankings Prediction</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="index_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-dark-2fef5ea3f8957b3e4ecc936fc74692ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-ca8e19a0c687c9045b6fe32cb749e9c8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Rolling Stones Album Rankings Prediction</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Tamas Nemeth </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 1, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p><strong>Data Source</strong>: TidyTuesday Rolling Stone Top 500 Albums<br>
<strong>Tools</strong>: Python, scikit-learn, OpenAI API, Lifelines, Pandas</p>
<hr>
<section id="project-overview" class="level2">
<h2 class="anchored" data-anchor-id="project-overview">Project Overview</h2>
<p>This analysis investigates what characteristics make an album endure on the Rolling Stone Top 500 list over time. Using the Rolling Stone rankings from 2003, 2012, and 2020, I built predictive models to identify factors that contribute to an album’s lasting success.</p>
<p><strong>Key Techniques Used</strong>: - <strong>LLM-Enhanced Data Imputation</strong>: Using GPT-4 to fill missing genre data - <strong>Survival Analysis</strong>: Kaplan-Meier estimators for understanding album longevity - <strong>Advanced Feature Engineering</strong>: Custom binary indicators and systematic feature selection - <strong>Robust Cross-Validation</strong>: 20-repeat stratified k-fold validation</p>
<p><strong>Main Findings</strong>: - 92% of albums from 2003 remained on the list in 2012 - 64% of 2003 albums were still ranked in 2020 - Album type (Studio vs Live) emerged as the strongest predictor - Genre-specific patterns (Funk/Disco) showed significant predictive power</p>
<hr>
<div id="e852a84b" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split, cross_val_score</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> RepeatedStratifiedKFold</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler, OneHotEncoder</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> make_pipeline</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nltk.tokenize <span class="im">import</span> word_tokenize</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report, confusion_matrix</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifelines <span class="im">import</span> KaplanMeierFitter</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifelines.statistics <span class="im">import</span> logrank_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="fd7fe0d8" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(<span class="st">"https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2024/2024-05-07/rolling_stone.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Info about the dataset:"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data.info())</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">101</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Missing values in the dataset:"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data.isnull().<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Info about the dataset:
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 691 entries, 0 to 690
Data columns (total 21 columns):
 #   Column                    Non-Null Count  Dtype  
---  ------                    --------------  -----  
 0   sort_name                 691 non-null    object 
 1   clean_name                691 non-null    object 
 2   album                     691 non-null    object 
 3   rank_2003                 500 non-null    float64
 4   rank_2012                 500 non-null    float64
 5   rank_2020                 500 non-null    float64
 6   differential              691 non-null    int64  
 7   release_year              691 non-null    int64  
 8   genre                     527 non-null    object 
 9   type                      691 non-null    object 
 10  weeks_on_billboard        572 non-null    float64
 11  peak_billboard_position   691 non-null    int64  
 12  spotify_popularity        654 non-null    float64
 13  spotify_url               655 non-null    object 
 14  artist_member_count       686 non-null    float64
 15  artist_gender             686 non-null    object 
 16  artist_birth_year_sum     686 non-null    float64
 17  debut_album_release_year  686 non-null    float64
 18  ave_age_at_top_500        686 non-null    float64
 19  years_between             686 non-null    float64
 20  album_id                  691 non-null    object 
dtypes: float64(10), int64(3), object(8)
memory usage: 113.5+ KB
None
-----------------------------------------------------------------------------------------------------
Missing values in the dataset:
sort_name                     0
clean_name                    0
album                         0
rank_2003                   191
rank_2012                   191
rank_2020                   191
differential                  0
release_year                  0
genre                       164
type                          0
weeks_on_billboard          119
peak_billboard_position       0
spotify_popularity           37
spotify_url                  36
artist_member_count           5
artist_gender                 5
artist_birth_year_sum         5
debut_album_release_year      5
ave_age_at_top_500            5
years_between                 5
album_id                      0
dtype: int64</code></pre>
</div>
</div>
<p><code>sort_name</code> Name used for sorting.</p>
<p><code>clean_name</code> Clean name.</p>
<p><code>album</code> Album name.</p>
<p><code>rank_2003</code> Rank in 2003. NA if album not released yet or not in top 500.</p>
<p><code>rank_2012</code> Rank in 2012. NA if album not released yet or not in top 500.</p>
<p><code>rank_2020</code> Rank in 2020. NA if not in top 500.</p>
<p><code>differential</code> 2020-2003 Differential. Negative value if it went down in the chart. Positive value if it went up.</p>
<p><code>release_year</code> Release Year.</p>
<p><code>genre</code> Album Genre.</p>
<p><code>type</code> Album Type.</p>
<p><code>weeks_on_billboard</code> Weeks on Billboard.</p>
<p><code>peak_billboard_position</code> Peak Billboard Position.</p>
<p><code>spotify_popularity</code> Spotify Popularity. NA if not on Spotify.</p>
<p><code>spotify_url</code> Spotify URL. NA if not on Spotify.</p>
<p><code>artist_member_count</code> Number of artists in the group.</p>
<p><code>artist_gender</code> Gender of the artist(s). Male/Female if it’s a mixed-gender group.</p>
<p><code>artist_birth_year_sum</code> Sum of the artists birth year. e.g.&nbsp;for a 2 member group, with one person born 1945 and another 1950, the value is 3895.</p>
<p><code>debut_album_release_year</code> Debut Album Release Year.</p>
<p><code>ave_age_at_top_500</code> Average age at top 500 Album.</p>
<p><code>years_between</code> Years Between Debut and Top 500 Album.</p>
<p><code>album_id</code> Album ID. NOS at the beginning of the ID if not on Spotify.</p>
<div id="0ca20d54" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>filtered_data <span class="op">=</span> data[data[<span class="st">"rank_2003"</span>].notna()].copy()</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>display(filtered_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">sort_name</th>
<th data-quarto-table-cell-role="th">clean_name</th>
<th data-quarto-table-cell-role="th">album</th>
<th data-quarto-table-cell-role="th">rank_2003</th>
<th data-quarto-table-cell-role="th">rank_2012</th>
<th data-quarto-table-cell-role="th">rank_2020</th>
<th data-quarto-table-cell-role="th">differential</th>
<th data-quarto-table-cell-role="th">release_year</th>
<th data-quarto-table-cell-role="th">genre</th>
<th data-quarto-table-cell-role="th">type</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">peak_billboard_position</th>
<th data-quarto-table-cell-role="th">spotify_popularity</th>
<th data-quarto-table-cell-role="th">spotify_url</th>
<th data-quarto-table-cell-role="th">artist_member_count</th>
<th data-quarto-table-cell-role="th">artist_gender</th>
<th data-quarto-table-cell-role="th">artist_birth_year_sum</th>
<th data-quarto-table-cell-role="th">debut_album_release_year</th>
<th data-quarto-table-cell-role="th">ave_age_at_top_500</th>
<th data-quarto-table-cell-role="th">years_between</th>
<th data-quarto-table-cell-role="th">album_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Sinatra, Frank</td>
<td>Frank Sinatra</td>
<td>In the Wee Small Hours</td>
<td>100.0</td>
<td>101.0</td>
<td>282.0</td>
<td>-182</td>
<td>1955</td>
<td>Big Band/Jazz</td>
<td>Studio</td>
<td>...</td>
<td>2</td>
<td>48.0</td>
<td>spotify:album:3GmwKB1tgPZgXeRJZSm9WX</td>
<td>1.0</td>
<td>Male</td>
<td>1915.0</td>
<td>1946.0</td>
<td>40.0</td>
<td>9.0</td>
<td>3GmwKB1tgPZgXeRJZSm9WX</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Diddley, Bo</td>
<td>Bo Diddley</td>
<td>Bo Diddley / Go Bo Diddley</td>
<td>214.0</td>
<td>216.0</td>
<td>455.0</td>
<td>-241</td>
<td>1955</td>
<td>Rock n' Roll/Rhythm &amp; Blues</td>
<td>Studio</td>
<td>...</td>
<td>201</td>
<td>50.0</td>
<td>spotify:album:1cbtDEwxCjMhglb49OgNBR</td>
<td>1.0</td>
<td>Male</td>
<td>1928.0</td>
<td>1955.0</td>
<td>27.0</td>
<td>0.0</td>
<td>1cbtDEwxCjMhglb49OgNBR</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Presley, Elvis</td>
<td>Elvis Presley</td>
<td>Elvis Presley</td>
<td>55.0</td>
<td>56.0</td>
<td>332.0</td>
<td>-277</td>
<td>1956</td>
<td>Rock n' Roll/Rhythm &amp; Blues</td>
<td>Studio</td>
<td>...</td>
<td>1</td>
<td>58.0</td>
<td>spotify:album:7GXP5OhYyPVLmcVfO9Iqin</td>
<td>1.0</td>
<td>Male</td>
<td>1935.0</td>
<td>1956.0</td>
<td>21.0</td>
<td>0.0</td>
<td>7GXP5OhYyPVLmcVfO9Iqin</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Sinatra, Frank</td>
<td>Frank Sinatra</td>
<td>Songs for Swingin' Lovers!</td>
<td>306.0</td>
<td>308.0</td>
<td>NaN</td>
<td>-195</td>
<td>1956</td>
<td>Big Band/Jazz</td>
<td>Studio</td>
<td>...</td>
<td>2</td>
<td>62.0</td>
<td>spotify:album:4kca7vXd1Wo5GE2DMafvMc</td>
<td>1.0</td>
<td>Male</td>
<td>1915.0</td>
<td>1946.0</td>
<td>41.0</td>
<td>10.0</td>
<td>4kca7vXd1Wo5GE2DMafvMc</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Little Richard</td>
<td>Little Richard</td>
<td>Here's Little Richard</td>
<td>50.0</td>
<td>50.0</td>
<td>227.0</td>
<td>-177</td>
<td>1957</td>
<td>NaN</td>
<td>Studio</td>
<td>...</td>
<td>13</td>
<td>64.0</td>
<td>spotify:album:18tV6PLXYvVjsdOVk0S7M8</td>
<td>1.0</td>
<td>Male</td>
<td>1932.0</td>
<td>1957.0</td>
<td>25.0</td>
<td>0.0</td>
<td>18tV6PLXYvVjsdOVk0S7M8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">684</td>
<td>Eminem</td>
<td>Eminem</td>
<td>The Eminem Show</td>
<td>317.0</td>
<td>NaN</td>
<td>NaN</td>
<td>-184</td>
<td>2002</td>
<td>Hip-Hop/Rap</td>
<td>Studio</td>
<td>...</td>
<td>1</td>
<td>87.0</td>
<td>spotify:album:2cWBwpqMsDJC1ZUwz813lo</td>
<td>1.0</td>
<td>Male</td>
<td>1972.0</td>
<td>1996.0</td>
<td>30.0</td>
<td>6.0</td>
<td>2cWBwpqMsDJC1ZUwz813lo</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">685</td>
<td>Wolf, Peter</td>
<td>Peter Wolf</td>
<td>Sleepless</td>
<td>432.0</td>
<td>427.0</td>
<td>NaN</td>
<td>-69</td>
<td>2002</td>
<td>NaN</td>
<td>Studio</td>
<td>...</td>
<td>201</td>
<td>30.0</td>
<td>spotify:album:6XZwHDglhO4A0C5Pa4xO4Q</td>
<td>1.0</td>
<td>Male</td>
<td>1946.0</td>
<td>1984.0</td>
<td>56.0</td>
<td>18.0</td>
<td>6XZwHDglhO4A0C5Pa4xO4Q</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">686</td>
<td>Beck</td>
<td>Beck</td>
<td>Sea Change</td>
<td>440.0</td>
<td>436.0</td>
<td>NaN</td>
<td>-61</td>
<td>2002</td>
<td>Indie/Alternative Rock</td>
<td>Studio</td>
<td>...</td>
<td>8</td>
<td>51.0</td>
<td>spotify:album:5ieP11rJQvuYz0Ov3k03cy</td>
<td>1.0</td>
<td>Male</td>
<td>1970.0</td>
<td>1993.0</td>
<td>32.0</td>
<td>9.0</td>
<td>5ieP11rJQvuYz0Ov3k03cy</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">687</td>
<td>Cooke, Sam</td>
<td>Sam Cooke</td>
<td>Portrait of a Legend 1951-1964</td>
<td>106.0</td>
<td>107.0</td>
<td>307.0</td>
<td>-201</td>
<td>2003</td>
<td>Soul/Gospel/R&amp;B</td>
<td>Greatest Hits</td>
<td>...</td>
<td>135</td>
<td>55.0</td>
<td>spotify:album:4jiO2jRz7g50ESvYYKsKwZ</td>
<td>1.0</td>
<td>Male</td>
<td>1931.0</td>
<td>1958.0</td>
<td>72.0</td>
<td>45.0</td>
<td>4jiO2jRz7g50ESvYYKsKwZ</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">688</td>
<td>White Stripes</td>
<td>The White Stripes</td>
<td>Elephant</td>
<td>390.0</td>
<td>390.0</td>
<td>449.0</td>
<td>-59</td>
<td>2003</td>
<td>Blues/Blues Rock</td>
<td>Studio</td>
<td>...</td>
<td>6</td>
<td>76.0</td>
<td>spotify:album:6D9urpsOWWKtYvF6PaorGE</td>
<td>2.0</td>
<td>Male/Female</td>
<td>3949.0</td>
<td>1999.0</td>
<td>28.5</td>
<td>4.0</td>
<td>6D9urpsOWWKtYvF6PaorGE</td>
</tr>
</tbody>
</table>

<p>500 rows × 21 columns</p>
</div>
</div>
</div>
<p>I removed every album that did not exist in 2003.<br>
Next I create 3 binary variables:<br>
<code>billboard_2003</code><br>
<code>billboard_2012</code><br>
<code>billboard_2020</code><br>
<em>With the following values</em><br>
<code>1</code> Was on the Billboard<br>
<code>0</code> Was not on Billboard</p>
<div id="b85ee55c" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>filtered_data[<span class="st">"billboard_2003"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="co"># since every album was on the billboard in 2003  </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>filtered_data[<span class="st">"billboard_2012"</span>] <span class="op">=</span> filtered_data[<span class="st">"rank_2012"</span>].notna().astype(<span class="bu">int</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>filtered_data[<span class="st">"billboard_2020"</span>] <span class="op">=</span> filtered_data[<span class="st">"rank_2020"</span>].notna().astype(<span class="bu">int</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>For the first analysis I am curious what makes an album a good album, so first I am creating a model from 2003 to 2012, and then based on the results predicting 2020.</p>
<p>Since genre is a very important predictor, and I have missing values, I used GPT to fill in their data.</p>
<div id="1c0539f4" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>data_for_llm <span class="op">=</span> filtered_data.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="75368f25" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>non_missing_data <span class="op">=</span> data_for_llm[data_for_llm[<span class="st">"genre"</span>].notna()]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>non_missing_data[<span class="st">"genre"</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>genre
Punk/Post-Punk/New Wave/Power Pop      71
Blues/Blues Rock                       60
Soul/Gospel/R&amp;B                        45
Country/Folk/Country Rock/Folk Rock    36
Indie/Alternative Rock                 35
Singer-Songwriter/Heartland Rock       26
Hip-Hop/Rap                            26
Hard Rock/Metal                        25
Funk/Disco                             15
Big Band/Jazz                          10
Rock n' Roll/Rhythm &amp; Blues            10
Reggae                                  7
Electronic                              7
Blues/Blues ROck                        1
Latin                                   1
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="972663af" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find rows with missing values</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>missing_genre_mask <span class="op">=</span> data_for_llm[<span class="st">"genre"</span>].isna()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create distinct dataset with only missing values</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>missing_data <span class="op">=</span> data_for_llm[missing_genre_mask].copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="4929208e" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>display(missing_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">sort_name</th>
<th data-quarto-table-cell-role="th">clean_name</th>
<th data-quarto-table-cell-role="th">album</th>
<th data-quarto-table-cell-role="th">rank_2003</th>
<th data-quarto-table-cell-role="th">rank_2012</th>
<th data-quarto-table-cell-role="th">rank_2020</th>
<th data-quarto-table-cell-role="th">differential</th>
<th data-quarto-table-cell-role="th">release_year</th>
<th data-quarto-table-cell-role="th">genre</th>
<th data-quarto-table-cell-role="th">type</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">artist_member_count</th>
<th data-quarto-table-cell-role="th">artist_gender</th>
<th data-quarto-table-cell-role="th">artist_birth_year_sum</th>
<th data-quarto-table-cell-role="th">debut_album_release_year</th>
<th data-quarto-table-cell-role="th">ave_age_at_top_500</th>
<th data-quarto-table-cell-role="th">years_between</th>
<th data-quarto-table-cell-role="th">album_id</th>
<th data-quarto-table-cell-role="th">billboard_2003</th>
<th data-quarto-table-cell-role="th">billboard_2012</th>
<th data-quarto-table-cell-role="th">billboard_2020</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Little Richard</td>
<td>Little Richard</td>
<td>Here's Little Richard</td>
<td>50.0</td>
<td>50.0</td>
<td>227.0</td>
<td>-177</td>
<td>1957</td>
<td>NaN</td>
<td>Studio</td>
<td>...</td>
<td>1.0</td>
<td>Male</td>
<td>1932.0</td>
<td>1957.0</td>
<td>25.00</td>
<td>0.0</td>
<td>18tV6PLXYvVjsdOVk0S7M8</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">18</td>
<td>Charles, Ray</td>
<td>Ray Charles</td>
<td>The Genius of Ray Charles</td>
<td>263.0</td>
<td>265.0</td>
<td>NaN</td>
<td>-238</td>
<td>1959</td>
<td>NaN</td>
<td>Studio</td>
<td>...</td>
<td>1.0</td>
<td>Male</td>
<td>1930.0</td>
<td>1949.0</td>
<td>29.00</td>
<td>10.0</td>
<td>4GFWnwli2cVOBp2G1zqhV1</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">43</td>
<td>Beatles</td>
<td>The Beatles</td>
<td>Please Please Me</td>
<td>39.0</td>
<td>39.0</td>
<td>NaN</td>
<td>-462</td>
<td>1963</td>
<td>NaN</td>
<td>Studio</td>
<td>...</td>
<td>4.0</td>
<td>Male</td>
<td>7765.0</td>
<td>1963.0</td>
<td>21.75</td>
<td>0.0</td>
<td>3KzAvEXcqJKBF97HrXwlgf</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">46</td>
<td>Beatles</td>
<td>The Beatles</td>
<td>With the Beatles</td>
<td>420.0</td>
<td>NaN</td>
<td>NaN</td>
<td>-81</td>
<td>1963</td>
<td>NaN</td>
<td>Studio</td>
<td>...</td>
<td>4.0</td>
<td>Male</td>
<td>7765.0</td>
<td>1963.0</td>
<td>21.75</td>
<td>0.0</td>
<td>1aYdiJk6XKeHWGO3FzHHTr</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">81</td>
<td>Beatles</td>
<td>The Beatles</td>
<td>Rubber Soul</td>
<td>5.0</td>
<td>5.0</td>
<td>35.0</td>
<td>-30</td>
<td>1965</td>
<td>NaN</td>
<td>Studio</td>
<td>...</td>
<td>4.0</td>
<td>Male</td>
<td>7765.0</td>
<td>1963.0</td>
<td>23.75</td>
<td>2.0</td>
<td>50o7kf2wLwVmOTVYJOTplm</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">649</td>
<td>Diamond, Neil</td>
<td>Neil Diamond</td>
<td>The Neil Diamond Collection</td>
<td>222.0</td>
<td>224.0</td>
<td>NaN</td>
<td>-279</td>
<td>1999</td>
<td>NaN</td>
<td>Greatest Hits</td>
<td>...</td>
<td>1.0</td>
<td>Male</td>
<td>1951.0</td>
<td>1966.0</td>
<td>48.00</td>
<td>33.0</td>
<td>NOS129</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">651</td>
<td>Waits, Tom</td>
<td>Tom Waits</td>
<td>Mule Variations</td>
<td>416.0</td>
<td>416.0</td>
<td>NaN</td>
<td>-85</td>
<td>1999</td>
<td>NaN</td>
<td>Studio</td>
<td>...</td>
<td>1.0</td>
<td>Male</td>
<td>1949.0</td>
<td>1973.0</td>
<td>50.00</td>
<td>26.0</td>
<td>7cAcex6xw4fP67ltgn1gm3</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">665</td>
<td>ABBA</td>
<td>ABBA</td>
<td>The Definitive Collection</td>
<td>180.0</td>
<td>179.0</td>
<td>303.0</td>
<td>-123</td>
<td>2001</td>
<td>NaN</td>
<td>Studio</td>
<td>...</td>
<td>4.0</td>
<td>Male/Female</td>
<td>7786.0</td>
<td>1973.0</td>
<td>54.50</td>
<td>28.0</td>
<td>34lTW6LuORpuIiYfqsetuq</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">671</td>
<td>Ronstadt, Linda</td>
<td>Linda Ronstadt</td>
<td>The Very Best of Linda Ronstadt</td>
<td>324.0</td>
<td>164.0</td>
<td>NaN</td>
<td>-177</td>
<td>2002</td>
<td>NaN</td>
<td>Greatest Hits</td>
<td>...</td>
<td>1.0</td>
<td>Female</td>
<td>1946.0</td>
<td>1969.0</td>
<td>56.00</td>
<td>33.0</td>
<td>NOS134</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">685</td>
<td>Wolf, Peter</td>
<td>Peter Wolf</td>
<td>Sleepless</td>
<td>432.0</td>
<td>427.0</td>
<td>NaN</td>
<td>-69</td>
<td>2002</td>
<td>NaN</td>
<td>Studio</td>
<td>...</td>
<td>1.0</td>
<td>Male</td>
<td>1946.0</td>
<td>1984.0</td>
<td>56.00</td>
<td>18.0</td>
<td>6XZwHDglhO4A0C5Pa4xO4Q</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>

<p>125 rows × 24 columns</p>
</div>
</div>
</div>
<div id="73c24a6d" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load_dotenv()</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># # Get API key</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># api_key = os.getenv("OPENAI_API_KEY")</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># # check</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># if not api_key:</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     raise ValueError("API_KEY not found in environment variables")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="22f5e8db" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># client = OpenAI()</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># total_rows = len(missing_data)</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># counter = 0</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># for index, row in missing_data.iterrows():</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     counter += 1</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"Processing {counter}/{total_rows}: {row['album']} by {row['clean_name']}")</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     response = client.chat.completions.create(</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">#         model="gpt-4.1-nano-2025-04-14",</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">#         messages=[</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">#             {"role": "system", "content": "You are a music expert. Provide concise and accurate genre classifications for albums based on the given options."},</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">#             {"role": "user", "content": f"""Based on the album '{row['album']}' and the artist '{row['clean_name']}',</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co">#                         give me the genre of the album if it is missing.</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co">#                         The genre can be one of the following: {list(genre)}.</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co">#                         If you don't know the genre, leave it blank.</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co">#                         If the genre is not in the list, write a new one. """}</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co">#         ],</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="co">#         max_completion_tokens=20, </span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co">#         temperature=0  </span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     response_text = response.choices[0].message.content.strip()</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"Response: {response_text}")</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="co">#     missing_data.loc[index, "genre"] = response_text</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="co"># display(missing_data)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="1a33f10e" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Backup the data.</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>missing_data.to_excel(<span class="st">"missing_genre.xlsx"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Since the model is a small model, I check it’s accuracy with an LLM-as-a-Judge.</p>
<div id="dff83f0b" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># missing_data_to_judge = missing_data.copy()</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># random_data = missing_data_to_judge.sample(10, random_state=123)</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># total_rows = len(random_data)</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># counter = 0</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># for index, row in random_data.iterrows():</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     counter += 1</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"Processing {counter}/{total_rows}: {row['album']} by {row['clean_name']}")</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     response = client.chat.completions.create(</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">#         model="gpt-4.1-2025-04-14",</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">#         messages=[</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">#             {"role": "system", "content": "You are a judge, judging another models response. Respond only with a number 1, 2. or 3."},</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co">#             {"role": "user", "content": f"""A smaller model was given a task to classify the genre of albums, </span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co">#                         based on the album '{row['album']}' and the artist '{row['clean_name']}'.</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co">#                         The genre can be one of the following: {list(genre)}.</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co">#                         If it did not know the genre, it was asked to leave it blank.</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co">#                         If the genre was not in the list, it wrote a new one. </span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="co">#                         Your job is to judge the response of the model '{row['genre']}'.</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co">#                         Rank the response on a scale from 1 to 3, where:</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="co">#                         1 - The response is completely wrong or irrelevant.</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co">#                         2 - The response is partially correct.</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co">#                         3 - The response is 100% correct.</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="co">#                         Format your response as: [Score]: [Brief reasoning]</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co">#                         If the score is 3, instead of reasoning write:</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co">#                         3: 3</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="co">#                         If it's 1 or 2, write a brief reasoning why the score is not 3."""}</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="co">#         ],</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co">#         max_completion_tokens=100, </span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="co">#         temperature=0  </span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a><span class="co">#     response_text = response.choices[0].message.content.strip()</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"Response: {response_text}")</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Parse score and reasoning</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="co">#     parts = response_text.split(':', 1)</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="co">#     score = parts[0].strip()</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a><span class="co">#     reasoning = parts[1].strip() </span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="co">#     random_data.loc[index, 'correctness_score'] = score</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a><span class="co">#     random_data.loc[index, 'reasoning'] = reasoning</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="co">#Backup</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a><span class="co"># random_data.to_excel("random_data.xlsx", index=False)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Although 4 out of 10 were incorrect, it still got 2 out of 3 correct. Inspecting the reasoning for the score of 2, I decided to move on with the model, since it is just a nuanced difference.</p>
<div id="94f1568b" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>missing_data[<span class="st">"genre"</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>Series([], Name: count, dtype: int64)</code></pre>
</div>
</div>
<div id="fe62c494" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#rs_data = Rolling Stones data </span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>rs_data <span class="op">=</span>pd.concat([missing_data, non_missing_data], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Backup</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>rs_data.to_excel(<span class="st">"rs_data.xlsx"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="d245344d" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>rs_data<span class="op">=</span> pd.read_excel(<span class="st">"rs_data.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="survival-analysis-of-the-albums" class="level1">
<h1>Survival analysis of the albums</h1>
<div id="050885fe" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create survival variables: duration and event</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>rs_data[<span class="st">'duration'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>rs_data[<span class="st">'event'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create duration and event for each album</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index, row <span class="kw">in</span> rs_data.iterrows():</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">'billboard_2012'</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Album dropped off between 2003-2012</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        rs_data.loc[index, <span class="st">'duration'</span>] <span class="op">=</span> <span class="dv">9</span>   <span class="co"># 2012 - 2003</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        rs_data.loc[index, <span class="st">'event'</span>] <span class="op">=</span> <span class="dv">1</span>      <span class="co"># Event occurred (dropped off)</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> row[<span class="st">'billboard_2020'</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Album stayed until 2012, but dropped off by 2020</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        rs_data.loc[index, <span class="st">'duration'</span>] <span class="op">=</span> <span class="dv">17</span>  <span class="co"># 2020 - 2003</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        rs_data.loc[index, <span class="st">'event'</span>] <span class="op">=</span> <span class="dv">1</span>      <span class="co"># Event occurred (dropped off)</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Album still on Billboard in 2020</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        rs_data.loc[index, <span class="st">'duration'</span>] <span class="op">=</span> <span class="dv">17</span>  <span class="co"># 2020 - 2003</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        rs_data.loc[index, <span class="st">'event'</span>] <span class="op">=</span> <span class="dv">0</span>      <span class="co"># Censored (still alive)</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Survival Variables Created:"</span>)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Duration distribution:"</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rs_data[<span class="st">'duration'</span>].value_counts().sort_index())</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Event distribution:"</span>)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rs_data[<span class="st">'event'</span>].value_counts())</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Total albums: </span><span class="sc">{</span><span class="bu">len</span>(rs_data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Albums that dropped off (events): </span><span class="sc">{</span>rs_data[<span class="st">'event'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Albums still on list (censored): </span><span class="sc">{</span>(rs_data[<span class="st">'event'</span>] <span class="op">==</span> <span class="dv">0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Survival Variables Created:
Duration distribution:
duration
9      36
17    464
Name: count, dtype: int64

Event distribution:
event
0    319
1    181
Name: count, dtype: int64

Total albums: 500
Albums that dropped off (events): 181
Albums still on list (censored): 319</code></pre>
</div>
</div>
<div id="30b32d47" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>kmf <span class="op">=</span> KaplanMeierFitter()</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>kmf.fit(rs_data[<span class="st">'duration'</span>], rs_data[<span class="st">'event'</span>])</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot overall survival curve</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>kmf.plot_survival_function(label<span class="op">=</span><span class="st">'All Albums'</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Album Survival on Rolling Stone Top 500 (2003-2020)'</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Years since 2003'</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Probability of Staying on Top 500'</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>plt.axvline(x<span class="op">=</span><span class="dv">9</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'2012 checkpoint'</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Print survival statistics</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Overall Survival Statistics:"</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Survival probability at 9 years (2012): </span><span class="sc">{</span>kmf<span class="sc">.</span>survival_function_at_times(<span class="dv">9</span>)<span class="sc">.</span>iloc[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Survival probability at 17 years (2020): </span><span class="sc">{</span>kmf<span class="sc">.</span>survival_function_at_times(<span class="dv">17</span>)<span class="sc">.</span>iloc[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Overall Survival Statistics:
Survival probability at 9 years (2012): 0.928
Survival probability at 17 years (2020): 0.638</code></pre>
</div>
</div>
<p>Analysis shows that 92% of the albums that were on the Billboard charts in 2003 were still present in 2012, and nearly 64% of 2003 albums were on the 2020 Billboard charts. But what makes for that success? In the following Logistic Regression models I try to answer this question.</p>
<p>I created a word count for album names, because I am curious if shorter names help albums perform better.</p>
<div id="997097b0" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index, rows <span class="kw">in</span> rs_data.iterrows():</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    words<span class="op">=</span> word_tokenize(rows[<span class="st">"album"</span>])</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    word_count <span class="op">=</span> <span class="bu">len</span>(words)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    rs_data.loc[index, <span class="st">"album_name_word_count"</span>] <span class="op">=</span> word_count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="e01c83f6" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>display(rs_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">sort_name</th>
<th data-quarto-table-cell-role="th">clean_name</th>
<th data-quarto-table-cell-role="th">album</th>
<th data-quarto-table-cell-role="th">rank_2003</th>
<th data-quarto-table-cell-role="th">rank_2012</th>
<th data-quarto-table-cell-role="th">rank_2020</th>
<th data-quarto-table-cell-role="th">differential</th>
<th data-quarto-table-cell-role="th">release_year</th>
<th data-quarto-table-cell-role="th">genre</th>
<th data-quarto-table-cell-role="th">type</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">debut_album_release_year</th>
<th data-quarto-table-cell-role="th">ave_age_at_top_500</th>
<th data-quarto-table-cell-role="th">years_between</th>
<th data-quarto-table-cell-role="th">album_id</th>
<th data-quarto-table-cell-role="th">billboard_2003</th>
<th data-quarto-table-cell-role="th">billboard_2012</th>
<th data-quarto-table-cell-role="th">billboard_2020</th>
<th data-quarto-table-cell-role="th">duration</th>
<th data-quarto-table-cell-role="th">event</th>
<th data-quarto-table-cell-role="th">album_name_word_count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Little Richard</td>
<td>Little Richard</td>
<td>Here's Little Richard</td>
<td>50</td>
<td>50.0</td>
<td>227.0</td>
<td>-177</td>
<td>1957</td>
<td>NaN</td>
<td>Studio</td>
<td>...</td>
<td>1957.0</td>
<td>25.00</td>
<td>0.0</td>
<td>18tV6PLXYvVjsdOVk0S7M8</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>17</td>
<td>0</td>
<td>4.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Charles, Ray</td>
<td>Ray Charles</td>
<td>The Genius of Ray Charles</td>
<td>263</td>
<td>265.0</td>
<td>NaN</td>
<td>-238</td>
<td>1959</td>
<td>NaN</td>
<td>Studio</td>
<td>...</td>
<td>1949.0</td>
<td>29.00</td>
<td>10.0</td>
<td>4GFWnwli2cVOBp2G1zqhV1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>17</td>
<td>1</td>
<td>5.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Beatles</td>
<td>The Beatles</td>
<td>Please Please Me</td>
<td>39</td>
<td>39.0</td>
<td>NaN</td>
<td>-462</td>
<td>1963</td>
<td>NaN</td>
<td>Studio</td>
<td>...</td>
<td>1963.0</td>
<td>21.75</td>
<td>0.0</td>
<td>3KzAvEXcqJKBF97HrXwlgf</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>17</td>
<td>1</td>
<td>3.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Beatles</td>
<td>The Beatles</td>
<td>With the Beatles</td>
<td>420</td>
<td>NaN</td>
<td>NaN</td>
<td>-81</td>
<td>1963</td>
<td>NaN</td>
<td>Studio</td>
<td>...</td>
<td>1963.0</td>
<td>21.75</td>
<td>0.0</td>
<td>1aYdiJk6XKeHWGO3FzHHTr</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>1</td>
<td>3.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Beatles</td>
<td>The Beatles</td>
<td>Rubber Soul</td>
<td>5</td>
<td>5.0</td>
<td>35.0</td>
<td>-30</td>
<td>1965</td>
<td>NaN</td>
<td>Studio</td>
<td>...</td>
<td>1963.0</td>
<td>23.75</td>
<td>2.0</td>
<td>50o7kf2wLwVmOTVYJOTplm</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>17</td>
<td>0</td>
<td>2.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">495</td>
<td>Coldplay</td>
<td>Coldplay</td>
<td>A Rush of Blood to the Head</td>
<td>473</td>
<td>466.0</td>
<td>324.0</td>
<td>149</td>
<td>2002</td>
<td>Indie/Alternative Rock</td>
<td>Studio</td>
<td>...</td>
<td>2000.0</td>
<td>24.50</td>
<td>2.0</td>
<td>0RHX9XECH8IVI3LNgWDpmQ</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>17</td>
<td>0</td>
<td>7.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">496</td>
<td>Eminem</td>
<td>Eminem</td>
<td>The Eminem Show</td>
<td>317</td>
<td>NaN</td>
<td>NaN</td>
<td>-184</td>
<td>2002</td>
<td>Hip-Hop/Rap</td>
<td>Studio</td>
<td>...</td>
<td>1996.0</td>
<td>30.00</td>
<td>6.0</td>
<td>2cWBwpqMsDJC1ZUwz813lo</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>1</td>
<td>3.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">497</td>
<td>Beck</td>
<td>Beck</td>
<td>Sea Change</td>
<td>440</td>
<td>436.0</td>
<td>NaN</td>
<td>-61</td>
<td>2002</td>
<td>Indie/Alternative Rock</td>
<td>Studio</td>
<td>...</td>
<td>1993.0</td>
<td>32.00</td>
<td>9.0</td>
<td>5ieP11rJQvuYz0Ov3k03cy</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>17</td>
<td>1</td>
<td>2.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">498</td>
<td>Cooke, Sam</td>
<td>Sam Cooke</td>
<td>Portrait of a Legend 1951-1964</td>
<td>106</td>
<td>107.0</td>
<td>307.0</td>
<td>-201</td>
<td>2003</td>
<td>Soul/Gospel/R&amp;B</td>
<td>Greatest Hits</td>
<td>...</td>
<td>1958.0</td>
<td>72.00</td>
<td>45.0</td>
<td>4jiO2jRz7g50ESvYYKsKwZ</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>17</td>
<td>0</td>
<td>5.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">499</td>
<td>White Stripes</td>
<td>The White Stripes</td>
<td>Elephant</td>
<td>390</td>
<td>390.0</td>
<td>449.0</td>
<td>-59</td>
<td>2003</td>
<td>Blues/Blues Rock</td>
<td>Studio</td>
<td>...</td>
<td>1999.0</td>
<td>28.50</td>
<td>4.0</td>
<td>6D9urpsOWWKtYvF6PaorGE</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>17</td>
<td>0</td>
<td>1.0</td>
</tr>
</tbody>
</table>

<p>500 rows × 27 columns</p>
</div>
</div>
</div>
<div id="9544dee8" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>rs_data[<span class="st">"billboard_2012"</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>billboard_2012
1    464
0     36
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="93be16d3" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>rs_data[<span class="st">'type'</span>] <span class="op">=</span> rs_data[<span class="st">'type'</span>].replace(<span class="st">'Soundtrack'</span>, <span class="st">'Live'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="bc5728d4" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> group_rare_categories(df, column, min_count<span class="op">=</span><span class="dv">15</span>):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    value_counts <span class="op">=</span> df[column].value_counts()</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    rare_categories <span class="op">=</span> value_counts[value_counts <span class="op">&lt;</span> min_count].index</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    df_copy <span class="op">=</span> df.copy()</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    df_copy[column] <span class="op">=</span> df_copy[column].replace(rare_categories, <span class="st">'Other'</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_copy </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>rs_data_new <span class="op">=</span> group_rare_categories(rs_data, <span class="st">'genre'</span>, min_count<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>ml_data <span class="op">=</span> rs_data_new[[<span class="st">"billboard_2012"</span>, <span class="st">"release_year"</span>, <span class="st">"type"</span>, <span class="st">"genre"</span>, <span class="st">"album_name_word_count"</span>, <span class="st">"artist_gender"</span>,<span class="st">"debut_album_release_year"</span>, <span class="st">"years_between"</span>, <span class="st">"artist_member_count"</span>]].dropna()</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>numeric_features <span class="op">=</span> [<span class="st">"release_year"</span>, <span class="st">"album_name_word_count"</span>, <span class="st">"debut_album_release_year"</span>, <span class="st">"years_between"</span>, <span class="st">"artist_member_count"</span>]</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> [<span class="st">"type"</span>,<span class="st">"genre"</span>, <span class="st">"artist_gender"</span>]</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>X<span class="op">=</span> ml_data.drop(columns<span class="op">=</span>[<span class="st">"billboard_2012"</span>])</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>y<span class="op">=</span> ml_data[<span class="st">"billboard_2012"</span>]</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>X_train, X_holdout, y_train, y_holdout <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>, stratify<span class="op">=</span>y)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> RepeatedStratifiedKFold(</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    n_splits<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    n_repeats<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>) <span class="co"># n_repeats=20, because I want as robust results as possible</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'num'</span>, StandardScaler(), numeric_features),</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'cat'</span>, OneHotEncoder(drop<span class="op">=</span><span class="st">'first'</span>, handle_unknown<span class="op">=</span><span class="st">'infrequent_if_exist'</span>, min_frequency<span class="op">=</span><span class="dv">2</span>), categorical_features)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> make_pipeline(</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    preprocessor,</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    LogisticRegression(max_iter<span class="op">=</span><span class="dv">5000</span>)</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> cross_val_score(pipeline, X_train, y_train, cv<span class="op">=</span>cv, scoring<span class="op">=</span><span class="st">"roc_auc"</span>)</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(scores)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[0.35044643 0.44642857 0.56696429 0.57738095 0.64285714 0.37053571
 0.67857143 0.71875    0.2797619  0.44642857 0.54464286 0.6875
 0.42857143 0.50595238 0.4702381  0.62053571 0.54910714 0.29241071
 0.4702381  0.35714286 0.50892857 0.46428571 0.54017857 0.625
 0.86904762 0.52678571 0.57589286 0.57589286 0.55357143 0.41071429
 0.47321429 0.67410714 0.48660714 0.41071429 0.58928571 0.66964286
 0.34375    0.42857143 0.7202381  0.58928571 0.54464286 0.51339286
 0.59375    0.27380952 0.41666667 0.68303571 0.47767857 0.33928571
 0.42857143 0.43452381 0.49553571 0.44196429 0.58482143 0.42857143
 0.39285714 0.69642857 0.47321429 0.62053571 0.41071429 0.63095238
 0.38839286 0.79017857 0.39285714 0.70833333 0.41666667 0.703125
 0.375      0.54910714 0.375      0.5952381  0.54464286 0.33928571
 0.45535714 0.32142857 0.66666667 0.74553571 0.38392857 0.16964286
 0.64880952 0.45833333 0.30803571 0.51785714 0.68303571 0.63690476
 0.45238095 0.63392857 0.33482143 0.4375     0.82738095 0.79166667
 0.43303571 0.69196429 0.48660714 0.38690476 0.82738095 0.61607143
 0.41071429 0.38392857 0.58928571 0.63095238]</code></pre>
</div>
</div>
<div id="6d869d59" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_auc_score, classification_report</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the pipeline before making predictions</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>pipeline.fit(X_train, y_train)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Correct way to get ROC-AUC</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>y_pred_proba <span class="op">=</span> pipeline.predict_proba(X_holdout)[:, <span class="dv">1</span>]  <span class="co"># Probabilities for class 1</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>holdout_auc <span class="op">=</span> roc_auc_score(y_holdout, y_pred_proba)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Holdout ROC-AUC: </span><span class="sc">{</span>holdout_auc<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co"># For classification report</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> pipeline.predict(X_holdout)  <span class="co"># Hard predictions</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_holdout, y_pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Holdout ROC-AUC: 0.674
              precision    recall  f1-score   support

           0       0.00      0.00      0.00         5
           1       0.93      1.00      0.97        70

    accuracy                           0.93        75
   macro avg       0.47      0.50      0.48        75
weighted avg       0.87      0.93      0.90        75
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))
/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))
/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))</code></pre>
</div>
</div>
<p>Well… The model is not the best… Let’s do some feature engineering stuff.</p>
<div id="0789b23a" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your current baseline</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>baseline_score <span class="op">=</span> <span class="fl">0.513</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Test removing each feature with full CV</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>current_features <span class="op">=</span> [<span class="st">"release_year"</span>, <span class="st">"type"</span>, <span class="st">"genre"</span>, <span class="st">"album_name_word_count"</span>, </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"artist_gender"</span>, <span class="st">"debut_album_release_year"</span>, <span class="st">"years_between"</span>, </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"artist_member_count"</span>]</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Testing feature removal with cross-validation:"</span>)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Baseline (all features): </span><span class="sc">{</span>baseline_score<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>feature_removal_results <span class="op">=</span> {}</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature_to_remove <span class="kw">in</span> current_features:</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Testing removal of: </span><span class="sc">{</span>feature_to_remove<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create feature lists without this feature</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    remaining_features <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> current_features <span class="cf">if</span> f <span class="op">!=</span> feature_to_remove]</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    remaining_numeric <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> remaining_features <span class="cf">if</span> f <span class="kw">in</span> numeric_features]</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    remaining_categorical <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> remaining_features <span class="cf">if</span> f <span class="kw">in</span> categorical_features]</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skip if we remove all features of a type</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(remaining_numeric) <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> <span class="bu">len</span>(remaining_categorical) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  Skipping - would remove all features"</span>)</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create subset of data</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> remaining_features <span class="op">+</span> [<span class="st">"billboard_2012"</span>]</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    ml_data_subset <span class="op">=</span> ml_data[feature_cols].dropna()</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    X_subset <span class="op">=</span> ml_data_subset.drop(columns<span class="op">=</span>[<span class="st">"billboard_2012"</span>])</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>    y_subset <span class="op">=</span> ml_data_subset[<span class="st">"billboard_2012"</span>]</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create new preprocessor for remaining features</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    transformers <span class="op">=</span> []</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(remaining_numeric) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>        transformers.append((<span class="st">'num'</span>, StandardScaler(), remaining_numeric))</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(remaining_categorical) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>        transformers.append((<span class="st">'cat'</span>, OneHotEncoder(drop<span class="op">=</span><span class="st">'first'</span>, handle_unknown<span class="op">=</span><span class="st">'infrequent_if_exist'</span>, min_frequency<span class="op">=</span><span class="dv">2</span>), remaining_categorical))</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>    test_preprocessor <span class="op">=</span> ColumnTransformer(transformers<span class="op">=</span>transformers)</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create pipeline</span></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>    test_pipeline <span class="op">=</span> make_pipeline(</span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>        test_preprocessor,</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>        LogisticRegression(max_iter<span class="op">=</span><span class="dv">5000</span>)</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run cross-validation</span></span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>    X_train_subset, _, y_train_subset, _ <span class="op">=</span> train_test_split(</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>        X_subset, y_subset, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>, stratify<span class="op">=</span>y_subset</span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>    cv_scores <span class="op">=</span> cross_val_score(test_pipeline, X_train_subset, y_train_subset, cv<span class="op">=</span>cv, scoring<span class="op">=</span><span class="st">"roc_auc"</span>)</span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>    mean_score <span class="op">=</span> cv_scores.mean()</span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>    std_score <span class="op">=</span> cv_scores.std()</span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>    improvement <span class="op">=</span> mean_score <span class="op">-</span> baseline_score</span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a>    feature_removal_results[feature_to_remove] <span class="op">=</span> {</span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mean_score'</span>: mean_score,</span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">'std_score'</span>: std_score,</span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">'improvement'</span>: improvement</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean ROC-AUC: </span><span class="sc">{</span>mean_score<span class="sc">:.3f}</span><span class="ss"> ± </span><span class="sc">{</span>std_score<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Change: </span><span class="sc">{</span>improvement<span class="sc">:+.3f}</span><span class="ss">"</span>)</span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of results</span></span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"SUMMARY - Feature Removal Results:"</span>)</span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by improvement</span></span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a>sorted_results <span class="op">=</span> <span class="bu">sorted</span>(feature_removal_results.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>][<span class="st">'improvement'</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature, results <span class="kw">in</span> sorted_results:</span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a>    status <span class="op">=</span> <span class="st">"🟢 IMPROVE"</span> <span class="cf">if</span> results[<span class="st">'improvement'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"🔴 WORSEN"</span></span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>status<span class="sc">}</span><span class="ss"> Remove '</span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">': </span><span class="sc">{</span>results[<span class="st">'mean_score'</span>]<span class="sc">:.3f}</span><span class="ss"> (</span><span class="sc">{</span>results[<span class="st">'improvement'</span>]<span class="sc">:+.3f}</span><span class="ss">)"</span>)</span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify features to remove</span></span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a>features_to_remove <span class="op">=</span> [feature <span class="cf">for</span> feature, results <span class="kw">in</span> feature_removal_results.items() </span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">if</span> results[<span class="st">'improvement'</span>] <span class="op">&gt;</span> <span class="fl">0.01</span>]  <span class="co"># Improvement &gt; 1%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Testing feature removal with cross-validation:
Baseline (all features): 0.513
--------------------------------------------------
Testing removal of: release_year
  Mean ROC-AUC: 0.516 ± 0.142
  Change: +0.003

Testing removal of: type
  Mean ROC-AUC: 0.527 ± 0.142
  Change: +0.014

Testing removal of: genre
  Mean ROC-AUC: 0.583 ± 0.141
  Change: +0.070

Testing removal of: album_name_word_count
  Mean ROC-AUC: 0.546 ± 0.143
  Change: +0.033

Testing removal of: artist_gender
  Mean ROC-AUC: 0.541 ± 0.134
  Change: +0.028

Testing removal of: debut_album_release_year
  Mean ROC-AUC: 0.515 ± 0.141
  Change: +0.002

Testing removal of: years_between
  Mean ROC-AUC: 0.523 ± 0.140
  Change: +0.010

Testing removal of: artist_member_count
  Mean ROC-AUC: 0.543 ± 0.153
  Change: +0.030

============================================================
SUMMARY - Feature Removal Results:
============================================================
🟢 IMPROVE Remove 'genre': 0.583 (+0.070)
🟢 IMPROVE Remove 'album_name_word_count': 0.546 (+0.033)
🟢 IMPROVE Remove 'artist_member_count': 0.543 (+0.030)
🟢 IMPROVE Remove 'artist_gender': 0.541 (+0.028)
🟢 IMPROVE Remove 'type': 0.527 (+0.014)
🟢 IMPROVE Remove 'years_between': 0.523 (+0.010)
🟢 IMPROVE Remove 'release_year': 0.516 (+0.003)
🟢 IMPROVE Remove 'debut_album_release_year': 0.515 (+0.002)</code></pre>
</div>
</div>
<p>Based on the results I will remove some features. But must all features from the subgroup go? Let’s see.</p>
<div id="fee34662" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the pipeline to see feature importance</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>pipeline.fit(X_train, y_train)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get feature names after preprocessing</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>feature_names <span class="op">=</span> pipeline.named_steps[<span class="st">'columntransformer'</span>].get_feature_names_out()</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get coefficients (feature importance for logistic regression)</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>coefficients <span class="op">=</span> pipeline.named_steps[<span class="st">'logisticregression'</span>].coef_[<span class="dv">0</span>]</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create feature importance dataframe</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>feature_importance <span class="op">=</span> pd.DataFrame({</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'feature'</span>: feature_names,</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'importance'</span>: np.<span class="bu">abs</span>(coefficients)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>}).sort_values(<span class="st">'importance'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Feature Importance (absolute coefficients):"</span>)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(feature_importance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Feature Importance (absolute coefficients):
                                           feature  importance
16                      cat__genre_Soul/Gospel/R&amp;B    0.440937
5                          cat__type_Greatest Hits    0.416112
10                      cat__genre_Hard Rock/Metal    0.403003
9                            cat__genre_Funk/Disco    0.398599
12               cat__genre_Indie/Alternative Rock    0.393213
13                                cat__genre_Other    0.386029
2                    num__debut_album_release_year    0.337563
0                                num__release_year    0.325349
17                         cat__artist_gender_Male    0.266200
14    cat__genre_Punk/Post-Punk/New Wave/Power Pop    0.246924
8   cat__genre_Country/Folk/Country Rock/Folk Rock    0.207410
11                          cat__genre_Hip-Hop/Rap    0.195138
18                  cat__artist_gender_Male/Female    0.186560
4                         num__artist_member_count    0.138215
6                                   cat__type_Live    0.130383
15     cat__genre_Singer-Songwriter/Heartland Rock    0.119050
7                                 cat__type_Studio    0.117716
3                               num__years_between    0.028703
1                       num__album_name_word_count    0.004589</code></pre>
</div>
</div>
<div id="e40cf428" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>ml_data_engineered <span class="op">=</span> ml_data.copy()</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>ml_data_engineered[<span class="st">"is_funk/disco"</span>] <span class="op">=</span> (ml_data[<span class="st">"genre"</span>] <span class="op">==</span> <span class="st">"Funk/Disco"</span>).astype(<span class="bu">int</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>ml_data_engineered[<span class="st">"is_soul/gospel"</span>] <span class="op">=</span> (ml_data[<span class="st">"genre"</span>] <span class="op">==</span> <span class="st">"Soul/Gospel/R&amp;B"</span>).astype(<span class="bu">int</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>ml_data_engineered <span class="op">=</span> ml_data_engineered.drop(columns<span class="op">=</span>[<span class="st">"genre"</span>, <span class="st">"album_name_word_count"</span>, <span class="st">"years_between"</span>, <span class="st">"artist_member_count"</span>, <span class="st">"artist_gender"</span>, <span class="st">"debut_album_release_year"</span>, <span class="st">"release_year"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="a674b6ca" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> [<span class="st">"type"</span>, <span class="st">"is_funk/disco"</span>, <span class="st">"is_soul/gospel"</span>]</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> ml_data_engineered.drop(columns<span class="op">=</span>[<span class="st">"billboard_2012"</span>])</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> ml_data_engineered[<span class="st">"billboard_2012"</span>]</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>X_train, X_holdout, y_train, y_holdout <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>, stratify<span class="op">=</span>y)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> RepeatedStratifiedKFold(</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    n_splits<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    n_repeats<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>) <span class="co"># n_repeats=20, because I want as robust results as possible</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'cat'</span>, OneHotEncoder(drop<span class="op">=</span><span class="st">'first'</span>, handle_unknown<span class="op">=</span><span class="st">'infrequent_if_exist'</span>, min_frequency<span class="op">=</span><span class="dv">2</span>), categorical_features)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> make_pipeline(</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    preprocessor,</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    LogisticRegression(max_iter<span class="op">=</span><span class="dv">5000</span>)</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> cross_val_score(pipeline, X_train, y_train, cv<span class="op">=</span>cv, scoring<span class="op">=</span><span class="st">"roc_auc"</span>)</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(scores)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[0.63392857 0.32366071 0.57142857 0.59821429 0.52678571 0.625
 0.45089286 0.5625     0.59821429 0.43154762 0.60714286 0.57142857
 0.49107143 0.46428571 0.57142857 0.57142857 0.60714286 0.59821429
 0.42559524 0.44642857 0.51116071 0.53571429 0.5625     0.44345238
 0.58035714 0.51785714 0.515625   0.58035714 0.42261905 0.61607143
 0.61607143 0.58928571 0.47544643 0.49404762 0.52678571 0.58928571
 0.58035714 0.38839286 0.58035714 0.61607143 0.484375   0.57142857
 0.57142857 0.51785714 0.45238095 0.49107143 0.48883929 0.53571429
 0.57142857 0.64285714 0.52678571 0.49776786 0.515625   0.60714286
 0.55357143 0.64285714 0.48214286 0.46428571 0.57142857 0.66964286
 0.49776786 0.57142857 0.58035714 0.58035714 0.39880952 0.57142857
 0.57142857 0.47098214 0.46130952 0.55357143 0.59821429 0.36383929
 0.59821429 0.58928571 0.55357143 0.58035714 0.51785714 0.34598214
 0.64285714 0.59821429 0.52008929 0.50223214 0.55357143 0.57142857
 0.53571429 0.54464286 0.52455357 0.484375   0.5        0.66071429
 0.484375   0.54241071 0.53571429 0.65178571 0.61607143 0.57142857
 0.57142857 0.52232143 0.39880952 0.55357143]</code></pre>
</div>
</div>
<div id="d632b772" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the pipeline before making predictions</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>pipeline.fit(X_train, y_train)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Correct way to get ROC-AUC</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>y_pred_proba <span class="op">=</span> pipeline.predict_proba(X_holdout)[:, <span class="dv">1</span>]  <span class="co"># Probabilities for class 1</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>holdout_auc <span class="op">=</span> roc_auc_score(y_holdout, y_pred_proba)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Holdout ROC-AUC: </span><span class="sc">{</span>holdout_auc<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co"># For classification report</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> pipeline.predict(X_holdout)  <span class="co"># Hard predictions</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_holdout, y_pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Holdout ROC-AUC: 0.607
              precision    recall  f1-score   support

           0       0.00      0.00      0.00         5
           1       0.93      1.00      0.97        70

    accuracy                           0.93        75
   macro avg       0.47      0.50      0.48        75
weighted avg       0.87      0.93      0.90        75
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))
/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))
/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))</code></pre>
</div>
</div>
<div id="c514ea67" class="cell" data-execution_count="29">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your current baseline</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>baseline_score <span class="op">=</span> <span class="fl">0.504</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Test removing each feature with full CV</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>current_features <span class="op">=</span> [<span class="st">"type"</span>, <span class="st">"is_funk/disco"</span>, <span class="st">"is_soul/gospel"</span>]</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Testing feature removal with cross-validation:"</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Baseline (all features): </span><span class="sc">{</span>baseline_score<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>feature_removal_results <span class="op">=</span> {}</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature_to_remove <span class="kw">in</span> current_features:</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Testing removal of: </span><span class="sc">{</span>feature_to_remove<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create feature lists without this feature</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    remaining_features <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> current_features <span class="cf">if</span> f <span class="op">!=</span> feature_to_remove]</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    remaining_numeric <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> remaining_features <span class="cf">if</span> f <span class="kw">in</span> numeric_features]</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    remaining_categorical <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> remaining_features <span class="cf">if</span> f <span class="kw">in</span> categorical_features]</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skip if we remove all features of a type</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(remaining_numeric) <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> <span class="bu">len</span>(remaining_categorical) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  Skipping - would remove all features"</span>)</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create subset of data</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> remaining_features <span class="op">+</span> [<span class="st">"billboard_2012"</span>]</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    ml_data_subset <span class="op">=</span> ml_data_engineered[feature_cols].dropna()</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    X_subset <span class="op">=</span> ml_data_subset.drop(columns<span class="op">=</span>[<span class="st">"billboard_2012"</span>])</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>    y_subset <span class="op">=</span> ml_data_subset[<span class="st">"billboard_2012"</span>]</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create new preprocessor for remaining features</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>    transformers <span class="op">=</span> []</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(remaining_numeric) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>        transformers.append((<span class="st">'num'</span>, StandardScaler(), remaining_numeric))</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(remaining_categorical) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>        transformers.append((<span class="st">'cat'</span>, OneHotEncoder(drop<span class="op">=</span><span class="st">'first'</span>, handle_unknown<span class="op">=</span><span class="st">'infrequent_if_exist'</span>, min_frequency<span class="op">=</span><span class="dv">2</span>), remaining_categorical))</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>    test_preprocessor <span class="op">=</span> ColumnTransformer(transformers<span class="op">=</span>transformers)</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create pipeline</span></span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>    test_pipeline <span class="op">=</span> make_pipeline(</span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>        test_preprocessor,</span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>        LogisticRegression(max_iter<span class="op">=</span><span class="dv">5000</span>)</span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run cross-validation</span></span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>    X_train_subset, _, y_train_subset, _ <span class="op">=</span> train_test_split(</span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>        X_subset, y_subset, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>, stratify<span class="op">=</span>y_subset</span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>    cv_scores <span class="op">=</span> cross_val_score(test_pipeline, X_train_subset, y_train_subset, cv<span class="op">=</span>cv, scoring<span class="op">=</span><span class="st">"roc_auc"</span>)</span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>    mean_score <span class="op">=</span> cv_scores.mean()</span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>    std_score <span class="op">=</span> cv_scores.std()</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>    improvement <span class="op">=</span> mean_score <span class="op">-</span> baseline_score</span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>    feature_removal_results[feature_to_remove] <span class="op">=</span> {</span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mean_score'</span>: mean_score,</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">'std_score'</span>: std_score,</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">'improvement'</span>: improvement</span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean ROC-AUC: </span><span class="sc">{</span>mean_score<span class="sc">:.3f}</span><span class="ss"> ± </span><span class="sc">{</span>std_score<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Change: </span><span class="sc">{</span>improvement<span class="sc">:+.3f}</span><span class="ss">"</span>)</span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of results</span></span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"SUMMARY - Feature Removal Results:"</span>)</span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by improvement</span></span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a>sorted_results <span class="op">=</span> <span class="bu">sorted</span>(feature_removal_results.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>][<span class="st">'improvement'</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature, results <span class="kw">in</span> sorted_results:</span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a>    status <span class="op">=</span> <span class="st">"🟢 IMPROVE"</span> <span class="cf">if</span> results[<span class="st">'improvement'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"🔴 WORSEN"</span></span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>status<span class="sc">}</span><span class="ss"> Remove '</span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">': </span><span class="sc">{</span>results[<span class="st">'mean_score'</span>]<span class="sc">:.3f}</span><span class="ss"> (</span><span class="sc">{</span>results[<span class="st">'improvement'</span>]<span class="sc">:+.3f}</span><span class="ss">)"</span>)</span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify features to remove</span></span>
<span id="cb43-81"><a href="#cb43-81" aria-hidden="true" tabindex="-1"></a>features_to_remove <span class="op">=</span> [feature <span class="cf">for</span> feature, results <span class="kw">in</span> feature_removal_results.items() </span>
<span id="cb43-82"><a href="#cb43-82" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">if</span> results[<span class="st">'improvement'</span>] <span class="op">&gt;</span> <span class="fl">0.01</span>]  <span class="co"># Improvement &gt; 1%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Testing feature removal with cross-validation:
Baseline (all features): 0.504
--------------------------------------------------
Testing removal of: type
  Mean ROC-AUC: 0.564 ± 0.063
  Change: +0.060

Testing removal of: is_funk/disco
  Mean ROC-AUC: 0.514 ± 0.067
  Change: +0.010

Testing removal of: is_soul/gospel
  Mean ROC-AUC: 0.497 ± 0.063
  Change: -0.007

============================================================
SUMMARY - Feature Removal Results:
============================================================
🟢 IMPROVE Remove 'type': 0.564 (+0.060)
🟢 IMPROVE Remove 'is_funk/disco': 0.514 (+0.010)
🔴 WORSEN Remove 'is_soul/gospel': 0.497 (-0.007)</code></pre>
</div>
</div>
<div id="c8697450" class="cell" data-execution_count="30">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the pipeline to see feature importance</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>pipeline.fit(X_train, y_train)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get feature names after preprocessing</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>feature_names <span class="op">=</span> pipeline.named_steps[<span class="st">'columntransformer'</span>].get_feature_names_out()</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get coefficients (feature importance for logistic regression)</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>coefficients <span class="op">=</span> pipeline.named_steps[<span class="st">'logisticregression'</span>].coef_[<span class="dv">0</span>]</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create feature importance dataframe</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>feature_importance <span class="op">=</span> pd.DataFrame({</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'feature'</span>: feature_names,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'importance'</span>: np.<span class="bu">abs</span>(coefficients)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>}).sort_values(<span class="st">'importance'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Feature Importance (absolute coefficients):"</span>)</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(feature_importance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Feature Importance (absolute coefficients):
                   feature  importance
3     cat__is_funk/disco_1    0.562904
4    cat__is_soul/gospel_1    0.477426
0  cat__type_Greatest Hits    0.421295
2         cat__type_Studio    0.100730
1           cat__type_Live    0.021884</code></pre>
</div>
</div>
<div id="6d3a0987" class="cell" data-execution_count="31">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>ml_data_engineered_2 <span class="op">=</span> ml_data_engineered.copy()</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>ml_data_engineered_2[<span class="st">"is_live"</span>] <span class="op">=</span> (ml_data[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"Live"</span>).astype(<span class="bu">int</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>ml_data_engineered_2[<span class="st">"is_studio"</span>] <span class="op">=</span> (ml_data[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"Studio"</span>).astype(<span class="bu">int</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="4c0a6b8c" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> [<span class="st">"is_funk/disco"</span>, <span class="st">"is_studio"</span>, <span class="st">"is_live"</span>]</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> ml_data_engineered_2.drop(columns<span class="op">=</span>[<span class="st">"billboard_2012"</span>])</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> ml_data_engineered_2[<span class="st">"billboard_2012"</span>]</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>X_train, X_holdout, y_train, y_holdout <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>, stratify<span class="op">=</span>y)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> RepeatedStratifiedKFold(</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    n_splits<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    n_repeats<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>) <span class="co"># n_repeats=20, because I want as robust results as possible</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Only add StandardScaler if numeric_features is not empty</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'cat'</span>, OneHotEncoder(drop<span class="op">=</span><span class="st">'first'</span>, handle_unknown<span class="op">=</span><span class="st">'infrequent_if_exist'</span>, min_frequency<span class="op">=</span><span class="dv">2</span>), categorical_features)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> make_pipeline(</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    preprocessor,</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>    LogisticRegression(max_iter<span class="op">=</span><span class="dv">5000</span>)</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> cross_val_score(pipeline, X_train, y_train, cv<span class="op">=</span>cv, scoring<span class="op">=</span><span class="st">"roc_auc"</span>)</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(scores)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[0.59821429 0.30803571 0.55357143 0.59821429 0.50892857 0.61607143
 0.48883929 0.5625     0.58035714 0.40178571 0.54464286 0.55357143
 0.45535714 0.41369048 0.60714286 0.54464286 0.58928571 0.54464286
 0.38690476 0.41369048 0.45758929 0.50892857 0.4375     0.4375
 0.50892857 0.50892857 0.453125   0.4375     0.41666667 0.57142857
 0.54464286 0.51785714 0.45089286 0.45238095 0.50892857 0.5625
 0.53571429 0.359375   0.60714286 0.58035714 0.47098214 0.55357143
 0.58035714 0.52678571 0.4047619  0.4375     0.44866071 0.53571429
 0.58035714 0.59821429 0.52678571 0.453125   0.48214286 0.55357143
 0.5        0.53571429 0.46875    0.44642857 0.58928571 0.61607143
 0.44419643 0.4375     0.54464286 0.60714286 0.38095238 0.54464286
 0.57142857 0.44196429 0.39880952 0.55357143 0.42857143 0.34151786
 0.5625     0.57142857 0.54464286 0.55357143 0.52678571 0.31919643
 0.58035714 0.58035714 0.46651786 0.45758929 0.54464286 0.58928571
 0.51785714 0.50892857 0.47098214 0.46875    0.50892857 0.58928571
 0.46875    0.50669643 0.52678571 0.58928571 0.5625     0.5625
 0.51785714 0.46875    0.37202381 0.50892857]</code></pre>
</div>
</div>
<div id="8e90404d" class="cell" data-execution_count="33">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>pipeline.fit(X_train, y_train)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>y_pred_proba <span class="op">=</span> pipeline.predict_proba(X_holdout)[:, <span class="dv">1</span>]  <span class="co"># Probabilities for class 1</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>holdout_auc <span class="op">=</span> roc_auc_score(y_holdout, y_pred_proba)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Holdout ROC-AUC: </span><span class="sc">{</span>holdout_auc<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="co"># For classification report</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> pipeline.predict(X_holdout)  <span class="co"># Hard predictions</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_holdout, y_pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Holdout ROC-AUC: 0.571
              precision    recall  f1-score   support

           0       0.00      0.00      0.00         5
           1       0.93      1.00      0.97        70

    accuracy                           0.93        75
   macro avg       0.47      0.50      0.48        75
weighted avg       0.87      0.93      0.90        75
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))
/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))
/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))</code></pre>
</div>
</div>
<div id="71da486b" class="cell" data-execution_count="34">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your current baseline</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>baseline_score <span class="op">=</span> <span class="fl">0.575</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Test removing each feature with full CV</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>current_features <span class="op">=</span> [<span class="st">"is_funk/disco"</span>, <span class="st">"is_studio"</span>, <span class="st">"is_live"</span>]</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Testing feature removal with cross-validation:"</span>)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Baseline (all features): </span><span class="sc">{</span>baseline_score<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>feature_removal_results <span class="op">=</span> {}</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature_to_remove <span class="kw">in</span> current_features:</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Testing removal of: </span><span class="sc">{</span>feature_to_remove<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create feature lists without this feature</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    remaining_features <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> current_features <span class="cf">if</span> f <span class="op">!=</span> feature_to_remove]</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>    remaining_numeric <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> remaining_features <span class="cf">if</span> f <span class="kw">in</span> numeric_features]</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    remaining_categorical <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> remaining_features <span class="cf">if</span> f <span class="kw">in</span> categorical_features]</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skip if we remove all features of a type</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(remaining_numeric) <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> <span class="bu">len</span>(remaining_categorical) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  Skipping - would remove all features"</span>)</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create subset of data</span></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> remaining_features <span class="op">+</span> [<span class="st">"billboard_2012"</span>]</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>    ml_data_subset <span class="op">=</span> ml_data_engineered_2[feature_cols].dropna()</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>    X_subset <span class="op">=</span> ml_data_subset.drop(columns<span class="op">=</span>[<span class="st">"billboard_2012"</span>])</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>    y_subset <span class="op">=</span> ml_data_subset[<span class="st">"billboard_2012"</span>]</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create new preprocessor for remaining features</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>    transformers <span class="op">=</span> []</span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(remaining_numeric) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>        transformers.append((<span class="st">'num'</span>, StandardScaler(), remaining_numeric))</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(remaining_categorical) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>        transformers.append((<span class="st">'cat'</span>, OneHotEncoder(drop<span class="op">=</span><span class="st">'first'</span>, handle_unknown<span class="op">=</span><span class="st">'infrequent_if_exist'</span>, min_frequency<span class="op">=</span><span class="dv">2</span>), remaining_categorical))</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>    test_preprocessor <span class="op">=</span> ColumnTransformer(transformers<span class="op">=</span>transformers)</span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create pipeline</span></span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>    test_pipeline <span class="op">=</span> make_pipeline(</span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>        test_preprocessor,</span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>        LogisticRegression(max_iter<span class="op">=</span><span class="dv">5000</span>)</span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run cross-validation</span></span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>    X_train_subset, _, y_train_subset, _ <span class="op">=</span> train_test_split(</span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>        X_subset, y_subset, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>, stratify<span class="op">=</span>y_subset</span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>    cv_scores <span class="op">=</span> cross_val_score(test_pipeline, X_train_subset, y_train_subset, cv<span class="op">=</span>cv, scoring<span class="op">=</span><span class="st">"roc_auc"</span>)</span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a>    mean_score <span class="op">=</span> cv_scores.mean()</span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a>    std_score <span class="op">=</span> cv_scores.std()</span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a>    improvement <span class="op">=</span> mean_score <span class="op">-</span> baseline_score</span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>    feature_removal_results[feature_to_remove] <span class="op">=</span> {</span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mean_score'</span>: mean_score,</span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">'std_score'</span>: std_score,</span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">'improvement'</span>: improvement</span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean ROC-AUC: </span><span class="sc">{</span>mean_score<span class="sc">:.3f}</span><span class="ss"> ± </span><span class="sc">{</span>std_score<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Change: </span><span class="sc">{</span>improvement<span class="sc">:+.3f}</span><span class="ss">"</span>)</span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of results</span></span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"SUMMARY - Feature Removal Results:"</span>)</span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by improvement</span></span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a>sorted_results <span class="op">=</span> <span class="bu">sorted</span>(feature_removal_results.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>][<span class="st">'improvement'</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-76"><a href="#cb53-76" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature, results <span class="kw">in</span> sorted_results:</span>
<span id="cb53-77"><a href="#cb53-77" aria-hidden="true" tabindex="-1"></a>    status <span class="op">=</span> <span class="st">"🟢 IMPROVE"</span> <span class="cf">if</span> results[<span class="st">'improvement'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"🔴 WORSEN"</span></span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>status<span class="sc">}</span><span class="ss"> Remove '</span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">': </span><span class="sc">{</span>results[<span class="st">'mean_score'</span>]<span class="sc">:.3f}</span><span class="ss"> (</span><span class="sc">{</span>results[<span class="st">'improvement'</span>]<span class="sc">:+.3f}</span><span class="ss">)"</span>)</span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify features to remove</span></span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a>features_to_remove <span class="op">=</span> [feature <span class="cf">for</span> feature, results <span class="kw">in</span> feature_removal_results.items() </span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">if</span> results[<span class="st">'improvement'</span>] <span class="op">&gt;</span> <span class="fl">0.01</span>]  <span class="co"># Improvement &gt; 1%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Testing feature removal with cross-validation:
Baseline (all features): 0.575
--------------------------------------------------
Testing removal of: is_funk/disco
  Mean ROC-AUC: 0.492 ± 0.070
  Change: -0.083

Testing removal of: is_studio
  Mean ROC-AUC: 0.487 ± 0.043
  Change: -0.088

Testing removal of: is_live
  Mean ROC-AUC: 0.522 ± 0.082
  Change: -0.053

============================================================
SUMMARY - Feature Removal Results:
============================================================
🔴 WORSEN Remove 'is_live': 0.522 (-0.053)
🔴 WORSEN Remove 'is_funk/disco': 0.492 (-0.083)
🔴 WORSEN Remove 'is_studio': 0.487 (-0.088)</code></pre>
</div>
</div>
<div id="a36708f9" class="cell" data-execution_count="35">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the pipeline to see feature importance</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>pipeline.fit(X_train, y_train)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get feature names after preprocessing</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>feature_names <span class="op">=</span> pipeline.named_steps[<span class="st">'columntransformer'</span>].get_feature_names_out()</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get coefficients (feature importance for logistic regression)</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>coefficients <span class="op">=</span> pipeline.named_steps[<span class="st">'logisticregression'</span>].coef_[<span class="dv">0</span>]</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create feature importance dataframe</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>feature_importance <span class="op">=</span> pd.DataFrame({</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'feature'</span>: feature_names,</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'importance'</span>: np.<span class="bu">abs</span>(coefficients)</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>}).sort_values(<span class="st">'importance'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Feature Importance (absolute coefficients):"</span>)</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(feature_importance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Feature Importance (absolute coefficients):
                feature  importance
0  cat__is_funk/disco_1    0.551448
1      cat__is_studio_1    0.248398
2        cat__is_live_1    0.069865</code></pre>
</div>
</div>
<div id="bd022a31" class="cell" data-execution_count="36">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>ml_data_engineered_3 <span class="op">=</span> ml_data.copy()</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>ml_data_engineered_3[<span class="st">"is_live"</span>] <span class="op">=</span> (ml_data[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"Live"</span>).astype(<span class="bu">int</span>)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>ml_data_engineered_3[<span class="st">"is_studio"</span>] <span class="op">=</span> (ml_data[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"Studio"</span>).astype(<span class="bu">int</span>)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>ml_data_engineered_3 <span class="op">=</span> ml_data_engineered_3.drop(columns<span class="op">=</span>[<span class="st">"genre"</span>, <span class="st">"album_name_word_count"</span>, <span class="st">"years_between"</span>, <span class="st">"artist_member_count"</span>, <span class="st">"artist_gender"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="9071dc05" class="cell" data-execution_count="37">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> [<span class="st">"is_studio"</span>, <span class="st">"is_live"</span>]</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> ml_data_engineered_3.drop(columns<span class="op">=</span>[<span class="st">"billboard_2012"</span>])</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> ml_data_engineered_3[<span class="st">"billboard_2012"</span>]</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>X_train, X_holdout, y_train, y_holdout <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>, stratify<span class="op">=</span>y)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> RepeatedStratifiedKFold(</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    n_splits<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    n_repeats<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>) <span class="co"># n_repeats=20, because I want as robust results as possible</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Only add StandardScaler if numeric_features is not empty</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'cat'</span>, OneHotEncoder(drop<span class="op">=</span><span class="st">'first'</span>, handle_unknown<span class="op">=</span><span class="st">'infrequent_if_exist'</span>, min_frequency<span class="op">=</span><span class="dv">2</span>), categorical_features)</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> make_pipeline(</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    preprocessor,</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>    LogisticRegression(max_iter<span class="op">=</span><span class="dv">5000</span>)</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> cross_val_score(pipeline, X_train, y_train, cv<span class="op">=</span>cv, scoring<span class="op">=</span><span class="st">"roc_auc"</span>)</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(scores)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[0.53571429 0.30803571 0.50892857 0.58035714 0.58035714 0.57142857
 0.48660714 0.55357143 0.5625     0.38988095 0.54464286 0.5625
 0.45089286 0.39583333 0.55357143 0.48214286 0.5625     0.52678571
 0.38690476 0.39880952 0.43526786 0.48214286 0.5625     0.41369048
 0.48214286 0.47321429 0.43973214 0.5625     0.39880952 0.55357143
 0.52678571 0.55357143 0.42410714 0.43154762 0.57142857 0.50892857
 0.51785714 0.34821429 0.58035714 0.5625     0.44642857 0.54464286
 0.53571429 0.5        0.39285714 0.42410714 0.44419643 0.49107143
 0.58035714 0.57142857 0.48214286 0.43526786 0.44866071 0.55357143
 0.5        0.53571429 0.45089286 0.43973214 0.57142857 0.57142857
 0.43080357 0.375      0.5625     0.58035714 0.375      0.47321429
 0.5625     0.43526786 0.38690476 0.53571429 0.51785714 0.33258929
 0.53571429 0.55357143 0.51785714 0.52678571 0.49107143 0.31696429
 0.55357143 0.5625     0.453125   0.43080357 0.50892857 0.58035714
 0.57142857 0.49107143 0.453125   0.453125   0.47321429 0.57142857
 0.453125   0.47991071 0.48214286 0.58035714 0.54464286 0.53571429
 0.48214286 0.44196429 0.36607143 0.57142857]</code></pre>
</div>
</div>
<div id="9872793d" class="cell" data-execution_count="38">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>pipeline.fit(X_train, y_train)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>y_pred_proba <span class="op">=</span> pipeline.predict_proba(X_holdout)[:, <span class="dv">1</span>]  <span class="co"># Probabilities for class 1</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>holdout_auc <span class="op">=</span> roc_auc_score(y_holdout, y_pred_proba)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Holdout ROC-AUC: </span><span class="sc">{</span>holdout_auc<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="co"># For classification report</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> pipeline.predict(X_holdout)  <span class="co"># Hard predictions</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_holdout, y_pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Holdout ROC-AUC: 0.571
              precision    recall  f1-score   support

           0       0.00      0.00      0.00         5
           1       0.93      1.00      0.97        70

    accuracy                           0.93        75
   macro avg       0.47      0.50      0.48        75
weighted avg       0.87      0.93      0.90        75
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))
/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))
/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))</code></pre>
</div>
</div>
<div id="9dc87d86" class="cell" data-execution_count="39">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your current baseline</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>baseline_score <span class="op">=</span> <span class="fl">0.563</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Test removing each feature with full CV</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>current_features <span class="op">=</span> [<span class="st">"is_studio"</span>, <span class="st">"is_live"</span>]</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Testing feature removal with cross-validation:"</span>)</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Baseline (all features): </span><span class="sc">{</span>baseline_score<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>feature_removal_results <span class="op">=</span> {}</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature_to_remove <span class="kw">in</span> current_features:</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Testing removal of: </span><span class="sc">{</span>feature_to_remove<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create feature lists without this feature</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>    remaining_features <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> current_features <span class="cf">if</span> f <span class="op">!=</span> feature_to_remove]</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>    remaining_numeric <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> remaining_features <span class="cf">if</span> f <span class="kw">in</span> numeric_features]</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>    remaining_categorical <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> remaining_features <span class="cf">if</span> f <span class="kw">in</span> categorical_features]</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skip if we remove all features of a type</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(remaining_numeric) <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> <span class="bu">len</span>(remaining_categorical) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  Skipping - would remove all features"</span>)</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create subset of data</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> remaining_features <span class="op">+</span> [<span class="st">"billboard_2012"</span>]</span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>    ml_data_subset <span class="op">=</span> ml_data_engineered_3[feature_cols].dropna()</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>    X_subset <span class="op">=</span> ml_data_subset.drop(columns<span class="op">=</span>[<span class="st">"billboard_2012"</span>])</span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>    y_subset <span class="op">=</span> ml_data_subset[<span class="st">"billboard_2012"</span>]</span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create new preprocessor for remaining features</span></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>    transformers <span class="op">=</span> []</span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(remaining_numeric) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a>        transformers.append((<span class="st">'num'</span>, StandardScaler(), remaining_numeric))</span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(remaining_categorical) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>        transformers.append((<span class="st">'cat'</span>, OneHotEncoder(drop<span class="op">=</span><span class="st">'first'</span>, handle_unknown<span class="op">=</span><span class="st">'infrequent_if_exist'</span>, min_frequency<span class="op">=</span><span class="dv">2</span>), remaining_categorical))</span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>    test_preprocessor <span class="op">=</span> ColumnTransformer(transformers<span class="op">=</span>transformers)</span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create pipeline</span></span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a>    test_pipeline <span class="op">=</span> make_pipeline(</span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>        test_preprocessor,</span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>        LogisticRegression(max_iter<span class="op">=</span><span class="dv">5000</span>)</span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run cross-validation</span></span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a>    X_train_subset, _, y_train_subset, _ <span class="op">=</span> train_test_split(</span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a>        X_subset, y_subset, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>, stratify<span class="op">=</span>y_subset</span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a>    cv_scores <span class="op">=</span> cross_val_score(test_pipeline, X_train_subset, y_train_subset, cv<span class="op">=</span>cv, scoring<span class="op">=</span><span class="st">"roc_auc"</span>)</span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a>    mean_score <span class="op">=</span> cv_scores.mean()</span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a>    std_score <span class="op">=</span> cv_scores.std()</span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a>    improvement <span class="op">=</span> mean_score <span class="op">-</span> baseline_score</span>
<span id="cb63-58"><a href="#cb63-58" aria-hidden="true" tabindex="-1"></a>    feature_removal_results[feature_to_remove] <span class="op">=</span> {</span>
<span id="cb63-59"><a href="#cb63-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mean_score'</span>: mean_score,</span>
<span id="cb63-60"><a href="#cb63-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">'std_score'</span>: std_score,</span>
<span id="cb63-61"><a href="#cb63-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">'improvement'</span>: improvement</span>
<span id="cb63-62"><a href="#cb63-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb63-63"><a href="#cb63-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-64"><a href="#cb63-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean ROC-AUC: </span><span class="sc">{</span>mean_score<span class="sc">:.3f}</span><span class="ss"> ± </span><span class="sc">{</span>std_score<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb63-65"><a href="#cb63-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Change: </span><span class="sc">{</span>improvement<span class="sc">:+.3f}</span><span class="ss">"</span>)</span>
<span id="cb63-66"><a href="#cb63-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb63-67"><a href="#cb63-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-68"><a href="#cb63-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of results</span></span>
<span id="cb63-69"><a href="#cb63-69" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb63-70"><a href="#cb63-70" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"SUMMARY - Feature Removal Results:"</span>)</span>
<span id="cb63-71"><a href="#cb63-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb63-72"><a href="#cb63-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-73"><a href="#cb63-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by improvement</span></span>
<span id="cb63-74"><a href="#cb63-74" aria-hidden="true" tabindex="-1"></a>sorted_results <span class="op">=</span> <span class="bu">sorted</span>(feature_removal_results.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>][<span class="st">'improvement'</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb63-75"><a href="#cb63-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-76"><a href="#cb63-76" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature, results <span class="kw">in</span> sorted_results:</span>
<span id="cb63-77"><a href="#cb63-77" aria-hidden="true" tabindex="-1"></a>    status <span class="op">=</span> <span class="st">"🟢 IMPROVE"</span> <span class="cf">if</span> results[<span class="st">'improvement'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"🔴 WORSEN"</span></span>
<span id="cb63-78"><a href="#cb63-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>status<span class="sc">}</span><span class="ss"> Remove '</span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">': </span><span class="sc">{</span>results[<span class="st">'mean_score'</span>]<span class="sc">:.3f}</span><span class="ss"> (</span><span class="sc">{</span>results[<span class="st">'improvement'</span>]<span class="sc">:+.3f}</span><span class="ss">)"</span>)</span>
<span id="cb63-79"><a href="#cb63-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-80"><a href="#cb63-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify features to remove</span></span>
<span id="cb63-81"><a href="#cb63-81" aria-hidden="true" tabindex="-1"></a>features_to_remove <span class="op">=</span> [feature <span class="cf">for</span> feature, results <span class="kw">in</span> feature_removal_results.items() </span>
<span id="cb63-82"><a href="#cb63-82" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">if</span> results[<span class="st">'improvement'</span>] <span class="op">&gt;</span> <span class="fl">0.01</span>]  <span class="co"># Improvement &gt; 1%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Testing feature removal with cross-validation:
Baseline (all features): 0.563
--------------------------------------------------
Testing removal of: is_studio
  Mean ROC-AUC: 0.461 ± 0.039
  Change: -0.102

Testing removal of: is_live
  Mean ROC-AUC: 0.503 ± 0.082
  Change: -0.060

============================================================
SUMMARY - Feature Removal Results:
============================================================
🔴 WORSEN Remove 'is_live': 0.503 (-0.060)
🔴 WORSEN Remove 'is_studio': 0.461 (-0.102)</code></pre>
</div>
</div>
<div id="86fd863a" class="cell" data-execution_count="40">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> [<span class="st">"is_studio"</span>]</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> ml_data_engineered_3[[<span class="st">"is_studio"</span>]]  <span class="co"># Use double brackets to get a DataFrame</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> ml_data_engineered_3[<span class="st">"billboard_2012"</span>]</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>X_train, X_holdout, y_train, y_holdout <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>, stratify<span class="op">=</span>y)</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> RepeatedStratifiedKFold(</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    n_splits<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    n_repeats<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>) <span class="co"># n_repeats=20, because I want as robust results as possible</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'cat'</span>, OneHotEncoder(drop<span class="op">=</span><span class="st">'first'</span>, handle_unknown<span class="op">=</span><span class="st">'infrequent_if_exist'</span>, min_frequency<span class="op">=</span><span class="dv">2</span>), categorical_features)</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> make_pipeline(</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>    preprocessor,</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>    LogisticRegression(max_iter<span class="op">=</span><span class="dv">5000</span>)</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> cross_val_score(pipeline, X_train, y_train, cv<span class="op">=</span>cv, scoring<span class="op">=</span><span class="st">"roc_auc"</span>)</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(scores)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[0.58928571 0.30357143 0.58035714 0.58035714 0.58035714 0.57142857
 0.5        0.55357143 0.5625     0.4047619  0.54464286 0.5625
 0.46428571 0.41369048 0.60714286 0.39285714 0.5625     0.58035714
 0.39583333 0.4047619  0.4375     0.55357143 0.40178571 0.43154762
 0.57142857 0.58035714 0.44642857 0.40178571 0.41369048 0.55357143
 0.58035714 0.55357143 0.4375     0.44940476 0.57142857 0.58035714
 0.57142857 0.33928571 0.58035714 0.5625     0.45535714 0.54464286
 0.58928571 0.60714286 0.39583333 0.42857143 0.45535714 0.40178571
 0.58035714 0.57142857 0.57142857 0.4375     0.46428571 0.55357143
 0.60714286 0.58928571 0.45535714 0.44642857 0.57142857 0.57142857
 0.4375     0.375      0.5625     0.58035714 0.38690476 0.58035714
 0.5625     0.44642857 0.39583333 0.60714286 0.39285714 0.33035714
 0.53571429 0.55357143 0.60714286 0.40178571 0.40178571 0.32142857
 0.55357143 0.5625     0.46428571 0.4375     0.58035714 0.58035714
 0.57142857 0.5625     0.45535714 0.46428571 0.58035714 0.57142857
 0.46428571 0.49107143 0.55357143 0.58035714 0.54464286 0.58928571
 0.39285714 0.44642857 0.37797619 0.57142857]</code></pre>
</div>
</div>
<div id="99906b59" class="cell" data-execution_count="41">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>pipeline.fit(X_train, y_train)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>y_pred_proba <span class="op">=</span> pipeline.predict_proba(X_holdout)[:, <span class="dv">1</span>]  <span class="co"># Probabilities for class 1</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>holdout_auc <span class="op">=</span> roc_auc_score(y_holdout, y_pred_proba)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Holdout ROC-AUC: </span><span class="sc">{</span>holdout_auc<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="co"># For classification report</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> pipeline.predict(X_holdout)  <span class="co"># Hard predictions</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_holdout, y_pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Holdout ROC-AUC: 0.571
              precision    recall  f1-score   support

           0       0.00      0.00      0.00         5
           1       0.93      1.00      0.97        70

    accuracy                           0.93        75
   macro avg       0.47      0.50      0.48        75
weighted avg       0.87      0.93      0.90        75
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))
/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))
/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))</code></pre>
</div>
</div>
<p>Although the ROC-AUC improved slightly, the model performed best at 0.57 with the following features: - <code>is_funk/disco</code> - <code>is_studio</code> - <code>is_live</code></p>
<section id="final-model-again" class="level2">
<h2 class="anchored" data-anchor-id="final-model-again">FINAL MODEL <em>again</em></h2>
<div id="58cda4ab" class="cell" data-execution_count="42">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>ml_data_engineered_2 <span class="op">=</span> ml_data_engineered.copy()</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>ml_data_engineered_2[<span class="st">"is_live"</span>] <span class="op">=</span> (ml_data[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"Live"</span>).astype(<span class="bu">int</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>ml_data_engineered_2[<span class="st">"is_studio"</span>] <span class="op">=</span> (ml_data[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"Studio"</span>).astype(<span class="bu">int</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="54bf738b" class="cell" data-execution_count="43">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> [<span class="st">"is_funk/disco"</span>, <span class="st">"is_studio"</span>, <span class="st">"is_live"</span>]</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> ml_data_engineered_2.drop(columns<span class="op">=</span>[<span class="st">"billboard_2012"</span>])</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> ml_data_engineered_2[<span class="st">"billboard_2012"</span>]</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>X_train, X_holdout, y_train, y_holdout <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>, stratify<span class="op">=</span>y)</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> RepeatedStratifiedKFold(</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    n_splits<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    n_repeats<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>) <span class="co"># n_repeats=20, because I want as robust results as possible</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Only add StandardScaler if numeric_features is not empty</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'cat'</span>, OneHotEncoder(drop<span class="op">=</span><span class="st">'first'</span>, handle_unknown<span class="op">=</span><span class="st">'infrequent_if_exist'</span>, min_frequency<span class="op">=</span><span class="dv">2</span>), categorical_features)</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline</span></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> make_pipeline(</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>    preprocessor,</span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>    LogisticRegression(max_iter<span class="op">=</span><span class="dv">5000</span>)</span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> cross_val_score(pipeline, X_train, y_train, cv<span class="op">=</span>cv, scoring<span class="op">=</span><span class="st">"roc_auc"</span>)</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(scores)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[0.59821429 0.30803571 0.55357143 0.59821429 0.50892857 0.61607143
 0.48883929 0.5625     0.58035714 0.40178571 0.54464286 0.55357143
 0.45535714 0.41369048 0.60714286 0.54464286 0.58928571 0.54464286
 0.38690476 0.41369048 0.45758929 0.50892857 0.4375     0.4375
 0.50892857 0.50892857 0.453125   0.4375     0.41666667 0.57142857
 0.54464286 0.51785714 0.45089286 0.45238095 0.50892857 0.5625
 0.53571429 0.359375   0.60714286 0.58035714 0.47098214 0.55357143
 0.58035714 0.52678571 0.4047619  0.4375     0.44866071 0.53571429
 0.58035714 0.59821429 0.52678571 0.453125   0.48214286 0.55357143
 0.5        0.53571429 0.46875    0.44642857 0.58928571 0.61607143
 0.44419643 0.4375     0.54464286 0.60714286 0.38095238 0.54464286
 0.57142857 0.44196429 0.39880952 0.55357143 0.42857143 0.34151786
 0.5625     0.57142857 0.54464286 0.55357143 0.52678571 0.31919643
 0.58035714 0.58035714 0.46651786 0.45758929 0.54464286 0.58928571
 0.51785714 0.50892857 0.47098214 0.46875    0.50892857 0.58928571
 0.46875    0.50669643 0.52678571 0.58928571 0.5625     0.5625
 0.51785714 0.46875    0.37202381 0.50892857]</code></pre>
</div>
</div>
<div id="fcc04d6a" class="cell" data-execution_count="44">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>pipeline.fit(X_train, y_train)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>y_pred_proba <span class="op">=</span> pipeline.predict_proba(X_holdout)[:, <span class="dv">1</span>]  <span class="co"># Probabilities for class 1</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>holdout_auc <span class="op">=</span> roc_auc_score(y_holdout, y_pred_proba)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Holdout ROC-AUC: </span><span class="sc">{</span>holdout_auc<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="co"># For classification report</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> pipeline.predict(X_holdout)  <span class="co"># Hard predictions</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_holdout, y_pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Holdout ROC-AUC: 0.571
              precision    recall  f1-score   support

           0       0.00      0.00      0.00         5
           1       0.93      1.00      0.97        70

    accuracy                           0.93        75
   macro avg       0.47      0.50      0.48        75
weighted avg       0.87      0.93      0.90        75
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))
/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))
/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))</code></pre>
</div>
</div>
</section>
</section>
<section id="final-model--predicting-the-2020-dataset" class="level1">
<h1>Final model- predicting the 2020 dataset</h1>
<div id="3b188a32" class="cell" data-execution_count="45">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Adding bilboard 2020 data to ml_data_engineered_2</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>ml_data_engineered_2[<span class="st">"billboard_2020"</span>] <span class="op">=</span> rs_data[<span class="st">"billboard_2020"</span>].copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="a4e5e77a" class="cell" data-execution_count="46">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>y_pred_2020 <span class="op">=</span> pipeline.predict(ml_data_engineered_2[categorical_features])</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>ml_data_engineered_2[<span class="st">"pred_2020"</span>] <span class="op">=</span> y_pred_2020</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="575b2502" class="cell" data-execution_count="47">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Comparing to the actual 2020 billboard presence</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(confusion_matrix(ml_data_engineered_2[<span class="st">'billboard_2020'</span>], ml_data_engineered_2[<span class="st">'pred_2020'</span>]))</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(ml_data_engineered_2[<span class="st">'billboard_2020'</span>], ml_data_engineered_2[<span class="st">'pred_2020'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[  0 121]
 [  0 252]]
              precision    recall  f1-score   support

           0       0.00      0.00      0.00       121
           1       0.68      1.00      0.81       252

    accuracy                           0.68       373
   macro avg       0.34      0.50      0.40       373
weighted avg       0.46      0.68      0.54       373
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))
/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))
/Users/nemethtamas/opt/anaconda3/envs/rolling_stones/lib/python3.12/site-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", len(result))</code></pre>
</div>
</div>
<p>Based on the model results, it predicts that all albums will be on the Billboard charts. This suggests we cannot predict future success from 2012 data alone. Note that I used only albums that were on the Billboard charts in 2003. There can be other important factors contributing to an album’s success that our model doesn’t capture. However, we must acknowledge that the data was not sufficient to predict success accurately. The model was also biased, as many more albums remained on the Billboard charts than dropped off. For a more accurate and comprehensive analysis, we need albums that were <strong>not</strong> on the Billboard charts in 2003 to create a more balanced dataset.</p>
<p>Also note that the original dataset contained albums that were older than 2003. Since I was curious what makes an album great in the long run, newer albums were not within the scope of this analysis.</p>
<hr>
<section id="key-insights-business-impact" class="level2">
<h2 class="anchored" data-anchor-id="key-insights-business-impact">🎯 Key Insights &amp; Business Impact</h2>
<section id="model-performance-summary" class="level3">
<h3 class="anchored" data-anchor-id="model-performance-summary"><strong>Model Performance Summary</strong></h3>
<ul>
<li><strong>Best ROC-AUC</strong>: 0.57 (meaningful improvement over random chance)</li>
<li><strong>Most Important Features</strong>: Album type (Studio vs Live) and genre (Funk/Disco)</li>
<li><strong>Prediction Challenge</strong>: Severe class imbalance (most albums remained on charts)</li>
</ul>
</section>
<section id="business-insights" class="level3">
<h3 class="anchored" data-anchor-id="business-insights"><strong>Business Insights</strong></h3>
<p><strong>1. Album Longevity Patterns</strong> - <strong>92% survival rate</strong> from 2003 to 2012 (9 years) - <strong>64% survival rate</strong> from 2003 to 2020 (17 years) - Classic albums show remarkable staying power</p>
<p><strong>2. Key Success Factors</strong> - <strong>Album Format</strong>: Studio albums vs Live albums have different survival patterns - <strong>Genre Influence</strong>: Funk/Disco albums show distinct longevity characteristics - <strong>Market Stability</strong>: The “classic” canon is relatively stable over time</p>
</section>
<section id="technical-achievements" class="level3">
<h3 class="anchored" data-anchor-id="technical-achievements"><strong>Technical Achievements</strong></h3>
<p><strong>1. Innovation in Data Science</strong> - Successfully used <strong>GPT-4 for data augmentation</strong> (60% accuracy) - Implemented <strong>LLM-as-a-Judge</strong> validation framework - Combined traditional ML with modern AI tools</p>
<p><strong>2. Methodological Rigor</strong> - <strong>Survival Analysis</strong>: Kaplan-Meier estimators for time-to-event modeling - <strong>Robust Validation</strong>: 20-repeat stratified cross-validation - <strong>Systematic Feature Engineering</strong>: Data-driven feature selection process</p>
</section>
<section id="challenges-limitations" class="level3">
<h3 class="anchored" data-anchor-id="challenges-limitations"><strong>Challenges &amp; Limitations</strong></h3>
<p><strong>1. Data Limitations</strong> - <strong>Class Imbalance</strong>: Most albums remained on charts (limited negative examples) - <strong>Temporal Scope</strong>: Only albums from 2003 baseline (missing broader context) - <strong>Missing Features</strong>: No streaming data, sales figures, or cultural impact metrics</p>
<p><strong>2. Model Limitations</strong> - <strong>Overfitting Tendency</strong>: Model predicts most albums will remain successful - <strong>Limited Predictive Power</strong>: ROC-AUC of 0.57 indicates modest performance - <strong>Bias</strong>: Dataset skewed toward already successful albums</p>
</section>
<section id="future-improvements" class="level3">
<h3 class="anchored" data-anchor-id="future-improvements"><strong>Future Improvements</strong></h3>
<p><strong>1. Data Enhancement</strong> - Include albums <strong>not</strong> on 2003 charts for better class balance - Add external data: streaming numbers, sales figures, cultural impact scores - Expand temporal range to include more recent albums</p>
<p><strong>2. Model Improvements</strong> - Apply <strong>class balancing techniques</strong> (SMOTE, undersampling) - Try <strong>ensemble methods</strong> (Random Forest, XGBoost) - Implement <strong>time-series analysis</strong> for temporal patterns</p>
<p><strong>3. Business Applications</strong> - <strong>Music Industry</strong>: Predict long-term album success - <strong>Investment</strong>: Identify undervalued music catalogs - <strong>Curation</strong>: Assist in building “timeless” playlists</p>
<hr>
</section>
</section>
<section id="project-summary" class="level2">
<h2 class="anchored" data-anchor-id="project-summary">📊 Project Summary</h2>
<p>This analysis demonstrates the intersection of <strong>traditional statistics</strong> (survival analysis), <strong>modern machine learning</strong> (sklearn pipelines), and <strong>cutting-edge AI</strong> (LLM data augmentation). While the predictive model shows modest performance, the methodological approach and innovative techniques showcase advanced data science capabilities suitable for real-world applications.</p>
<p><strong>Key Takeaway</strong>: Even with limited features, we can identify meaningful patterns in cultural longevity, though additional data and advanced techniques would be needed for production-level prediction accuracy.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>